import { DeviceResponse, SessionTranscript } from "@lukas.j.han/mdoc";
import { mdocContext } from "./context";
import { calculateJwkThumbprint } from "jose";
import { X509Certificate } from "@peculiar/x509";

export const encPubKey = {
  kty: "EC",
  crv: "P-256",
  x: "avzQ00iQLgQf8wxeTL8e_XGmYPDOyZY-wXeS5Kq-i5g",
  y: "jDUXZfH87bnw5RJ95UGoZI0aIcwJqJb6s0CB9gFQt8o",
  kid: "zDnaeXdbrTwXAncnZTHs4tWWe3kHmfKjf3w8RLeawf5mGrZTV",
  use: "enc",
};

const data =
  "uQADZ3ZlcnNpb25jMS4waWRvY3VtZW50c4GjZ2RvY1R5cGV1b3JnLmlzby4xODAxMy41LjEubURMbGlzc3VlclNpZ25lZLkAAmpuYW1lU3BhY2VzoXFvcmcuaXNvLjE4MDEzLjUuMYnYGFhTpGhkaWdlc3RJRBFmcmFuZG9tUKCSZwIHY8NkFwzDXmsUN0RxZWxlbWVudElkZW50aWZpZXJqZ2l2ZW5fbmFtZWxlbGVtZW50VmFsdWVlRXJpa2HYGFhapGhkaWdlc3RJRBgiZnJhbmRvbVAHCv6eF2I0KSJMVsDqdregcWVsZW1lbnRJZGVudGlmaWVya2ZhbWlseV9uYW1lbGVsZW1lbnRWYWx1ZWpNdXN0ZXJtYW5u2BhYW6RoZGlnZXN0SUQOZnJhbmRvbVB47VKa7u-8xwj8Nugl688FcWVsZW1lbnRJZGVudGlmaWVyamJpcnRoX2RhdGVsZWxlbWVudFZhbHVl2QPsajE5NzEtMDktMDHYGFhdpGhkaWdlc3RJRBgnZnJhbmRvbVCHBMhC8L5vxwHhuO8EK0rOcWVsZW1lbnRJZGVudGlmaWVyb2RvY3VtZW50X251bWJlcmxlbGVtZW50VmFsdWVpOTg3NjU0MzIx2BhYW6RoZGlnZXN0SUQAZnJhbmRvbVCkBVSJzvWVD9hAeTNqYxdQcWVsZW1lbnRJZGVudGlmaWVyamlzc3VlX2RhdGVsZWxlbWVudFZhbHVl2QPsajIwMjQtMDMtMTXYGFhdpGhkaWdlc3RJRBgdZnJhbmRvbVBpJRm6ovQ2NK27OxNHgVuicWVsZW1lbnRJZGVudGlmaWVya2V4cGlyeV9kYXRlbGVsZW1lbnRWYWx1ZdkD7GoyMDI4LTA5LTAx2BhYVqRoZGlnZXN0SUQYGGZyYW5kb21QSz8G-HhCftlJg4X0R7KVBnFlbGVtZW50SWRlbnRpZmllcm9pc3N1aW5nX2NvdW50cnlsZWxlbWVudFZhbHVlYlVT2BhYeaRoZGlnZXN0SUQVZnJhbmRvbVBYZnH6jmJ5fGXNq39m8f0LcWVsZW1lbnRJZGVudGlmaWVycWlzc3VpbmdfYXV0aG9yaXR5bGVsZW1lbnRWYWx1ZXgjVXRvcGlhIERlcGFydG1lbnQgb2YgTW90b3IgVmVoaWNsZXPYGFjupGhkaWdlc3RJRAFmcmFuZG9tUODBU-VEqueeOSlv05-Lm6dxZWxlbWVudElkZW50aWZpZXJyZHJpdmluZ19wcml2aWxlZ2VzbGVsZW1lbnRWYWx1ZYKjdXZlaGljbGVfY2F0ZWdvcnlfY29kZWFBamlzc3VlX2RhdGXZA-xqMjAxOC0wOC0wOWtleHBpcnlfZGF0ZdkD7GoyMDI4LTA5LTAxo3V2ZWhpY2xlX2NhdGVnb3J5X2NvZGVhQmppc3N1ZV9kYXRl2QPsajIwMTctMDItMjNrZXhwaXJ5X2RhdGXZA-xqMjAyOC0wOS0wMWppc3N1ZXJBdXRohEOhASahGCFZAo4wggKKMIICEaADAgECAhCNMsX4qnlv7M2I9ISiZBaxMAoGCCqGSM49BAMDMC4xHzAdBgNVBAMMFk9XRiBNdWx0aXBheiBURVNUIElBQ0ExCzAJBgNVBAYMAlVTMB4XDTI1MDgwMzA4NTQ0NFoXDTI2MTEwMTA4NTQ0NFowLDEdMBsGA1UEAwwUT1dGIE11bHRpcGF6IFRFU1QgRFMxCzAJBgNVBAYMAlVTMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEIdiq18QwUUIGb8lZ6e_Bz33P132ZdPFthDozSXXD_jQpsk7BliQjfrZ3GQ2GHS6aX4vgau0o2EC7RUs4Y6Ty9qOCAREwggENMB8GA1UdIwQYMBaAFKtlG-BWwpBT8d1_bOSHvmjeYMn1MA4GA1UdDwEB_wQEAwIHgDAVBgNVHSUBAf8ECzAJBgcogYxdBQECMEwGA1UdEgRFMEOGQWh0dHBzOi8vZ2l0aHViLmNvbS9vcGVud2FsbGV0LWZvdW5kYXRpb24tbGFicy9pZGVudGl0eS1jcmVkZW50aWFsMFYGA1UdHwRPME0wS6BJoEeGRWh0dHBzOi8vZ2l0aHViLmNvbS9vcGVud2FsbGV0LWZvdW5kYXRpb24tbGFicy9pZGVudGl0eS1jcmVkZW50aWFsL2NybDAdBgNVHQ4EFgQUcNOvcWSuRVSw2aaSLkE0q_jwFQYwCgYIKoZIzj0EAwMDZwAwZAIwI2kOGyXgj4X-rIuXYj-3bHReWgQ_eWe2EnOTfISlnBRlqWFWHjWiPoLVVPzL-oQvAjA63ZJTUJae7EaBQReVnfWGPu8WCc-duU6pIzWAt08ZfB_z5_g-oqmiHRfzm8eaiU5ZB7PYGFkHrqZndmVyc2lvbmMxLjBvZGlnZXN0QWxnb3JpdGhtZ1NIQS0yNTZnZG9jVHlwZXVvcmcuaXNvLjE4MDEzLjUuMS5tRExsdmFsdWVEaWdlc3RzonFvcmcuaXNvLjE4MDEzLjUuMbgoGCJYIL8eYV-kFnnM7CqJ313G8bwzifFY0EvW60u0Qe6LXghdEVggsnzQ4uwwaKXndBEPPPMcp9g0a8PSMVwANfaRn8S5_mkOWCAh4TOmq7lo9NR91bCUhGb5x9NDtxatrN_d6PwkszO2_ABYIMF7J3Xls6NWFy0uEUJ1I4NlvsEhiwLmLwJ2HylcYkBWGB1YIJMbMbSn_i1jAS2x6LhCdpn1s2844WtpfrJUlDhMMx3CGBhYIA3r_ZJzPftO8dSAuOywZBNqwIrw9A7Zgotk-WlCw-kvFVggtjP3ZeaV9Y2fNkGhI4KDm97KfZZ8QcbT32q-KwS6uF8YJ1ggV27-YQbqFpVVVCR7PQgcSkD_kcIKSj4noHZKCPjHn28MWCBWjsgic9UMlFBOypEe11_s2NLG7VbCcLmdOPbNMksY_AFYILiM-QaHTrcS0vnaftbYErEVPH1QOUxTf9Nsyqk_MvOoGCRYIDB3yqnRU2kxUhm87v95yN2mkEEouAzyLNvKEGZUwowdFFggD4Mvm1fl8z7P2iijgp7LdK6sDIp9l1Bx45Z3Ljkny-AQWCB8KnocmkuAUtdUJ20dAtDxEyjM7FhXNcIMj4XxWCidjxgZWCBO-eerzRr_JM5QGJQldE4idPp_EW8rTnkQNzpJ-Klp7hgfWCCvdLDwT1O6qDaUyEcFvF0UL1-5GiT-sJkMDanys0rHeghYINWL-5zzzk5b_eyC2NCyGMCqY285H1ZbrMPFa-MMNSxyGCBYIPlVO23FGP9VRhTaQvD55sqoZQoooXBTI0mXF1hJiMNMBVggi13xgT8B6d_sk_cOu5Qn4tvlRYV6dSfwksy1esVWONcYJlgg4PT0SuwkcxpCYGa5aUReX6fW9iz80i5tvneFBzl4BB8TWCBPl8iv4B5oSU1WmD9OQ8ddj0yH8cHXRWIYRDbtdr2QGhJYIJAOGQc-XMnjMnMDYQUxWk3Jiaz2YNyzWS-85BcZcsb5B1ggQblWl0TYG2GiW95y--0SH-SJmutj8KDHo2Lb9jNAM7gXWCCBxrEUm6xpwaAz1JKGWj4AtjJYDrl8p0G2q0FeO1go7Q9YIKwQKxVeuVeqmrMrqZWQpzeO1dh1hiSpWeZ4UY1hybrRGCpYILFxcIBX_m5pF_firzjmuqJ06RJzpR8LcUfeihc9IR50FlggerdWjlg5GeesUOQecTJ01UYV0317LBVhnu2bHa0XplwGWCD2OHpt-Gsqo3VWvkzaz9ohzdU0QmtMEHn01Me5ea1tYxgtWCA8JDBArC0dq_nQ7djtiiD4taVHaBGucB87DB00txDg-RgeWCB3cEKawKUeinkZTuZhHF1lk2F8WFSfVDivIy4yAhGWNwNYIB381iRjGZU41NV4FGoVOwJzeXLvsyZiQc5WGA8ydtwNGCxYIPbLuBxPVrMDwjz21B06SPBomNghb4Kx8iIyrZXTselrCVggC11d4hx85NtbvG5DI1g4gbs-CTGujfq8no6CRbq9NYUCWCDwg2WKwsOJlG2OaeqxGHE6TK1cMXha4pNvinB4d8PcxwtYIJtaM18uGeOB5RCV46OqDrmYVBWTLKT37IPq9gzgFx3wGCFYIJTmL_teHp6Be2K11Ypesc4_ai3GL10iw6oHi-a4NgYnGBxYIGgcd3LZzMior__yzkY6sdYAjcbvkhio45YrMVYnv-swDVggtc2Akx1mKwbRPcP-fo6-c4lpGsT8FF8TQ7y0zXlHMDwYKVggiRpeeKkOr4DznJC-ZdrWTkcqcAoPscI_cv-kXXoIeX8KWCCakyvIZzrElYWLHVh-Q4auNh_WW6n9NcClN1Tm4y6NGxgoWCCmBHWFa0xv70lC_fEJNnKoGKbGhRhwTsCVtXKBJBLgXHdvcmcuaXNvLjE4MDEzLjUuMS5hYW12YaYYG1ggNu29AIxeVDytr9JXC1ZV3EnTVce-TuZTHxcWNSp2l-MYI1gg9x6hduOvf6Nkb-D99ymgiAj-eanU27Zz2aGZhuh_V6oYGlggbF1iNcdETfpMMuhlsah5lNYVKk1Kb19jwwpmUUVfoH8YK1ggwF3F8zWL5D34u0c3o5c5B-Sgm9-w7EaIVDUrya75L2wEWCCTFvih_9odEX28KoOCIcsp8Do1SQ15HZA5oOZUsAU4eRglWCAC6cfIZYbae_8CdyNA-b8u1lASNODGwdv_FpNKJcniH21kZXZpY2VLZXlJbmZvoWlkZXZpY2VLZXmkAQIgASFYIEtAH3qglqTRgAgqtr35b3K8B8fac_SaD_AvKiDhA4twIlggOQt9xQpYUrbXxH2fg65v9hyOjEmDtxfS9DfdxR5SSPxsdmFsaWRpdHlJbmZvo2ZzaWduZWTAdDIwMjUtMDgtMDRUMDc6NTQ6NDRaaXZhbGlkRnJvbcB0MjAyNS0wOC0wNFQwNzo1NDo0NFpqdmFsaWRVbnRpbMB0MjAyNi0wOC0wNFQwODo1NDo0NFpYQCoQNxFp4hMvlgRihO0x_LmBE9ECSKx4iYgZrBZyMeGUMS2uhORAIC40BXiNOu_RSMOij1CkAiEs-N_F7NWI1KZsZGV2aWNlU2lnbmVkuQACam5hbWVTcGFjZXPYGEGgamRldmljZUF1dGi5AAFvZGV2aWNlU2lnbmF0dXJlhEOhASag9lhAdmu13TNH-KF7PYMGyZ5h1SWhq9GtebhtPwQAvMz8qTLprcM2RCrWBNfIoN9e6aBdoSuX8XIJc2-sBMDn-UeRiGZzdGF0dXMA";

const animoCert = new X509Certificate(`-----BEGIN CERTIFICATE-----
MIIBzzCCAXWgAwIBAgIQVwAFolWQim94gmyCic3bCTAKBggqhkjOPQQDAjAdMQ4w
DAYDVQQDEwVBbmltbzELMAkGA1UEBhMCTkwwHhcNMjQwNTAyMTQyMzMwWhcNMjgw
NTAyMTQyMzMwWjAdMQ4wDAYDVQQDEwVBbmltbzELMAkGA1UEBhMCTkwwWTATBgcq
hkjOPQIBBggqhkjOPQMBBwNCAAQC/YyBpcRQX8ZXpHfra1TNdSbS7qzgHYHJ3msb
Ir8TJLPNZI8Ul8zJlFdQVIVls5+5ClCbN+J9FUvhPGs4AzA+o4GWMIGTMB0GA1Ud
DgQWBBQv3zBo1i/1CfEgdvkIWDGO9lS1SzAOBgNVHQ8BAf8EBAMCAQYwIQYDVR0S
BBowGIYWaHR0cHM6Ly9mdW5rZS5hbmltby5pZDASBgNVHRMBAf8ECDAGAQH/AgEA
MCsGA1UdHwQkMCIwIKAeoByGGmh0dHBzOi8vZnVua2UuYW5pbW8uaWQvY3JsMAoG
CCqGSM49BAMCA0gAMEUCIQCTg80AmqVHJLaZt2uuhAtPqKIXafP2ghtd9OCmdD51
ZwIgKvVkrgTYlxSRAbmKY6MlkH8mM3SNcnEJk9fGVwJG++0=
-----END CERTIFICATE-----`);

async function main() {
  const nonce = "643130710188740422717281";
  const thumbprint = await calculateJwkThumbprint(encPubKey);
  console.log("jwk", thumbprint);

  const thumbprintDecoded = Buffer.from(thumbprint, "base64url");
  const uint8Array = Buffer.from(data, "base64url");
  const deviceResponse = DeviceResponse.decode(uint8Array);

  try {
    const result = await deviceResponse.verify(
      {
        trustedCertificates: [new Uint8Array(animoCert.rawData)],
        disableCertificateChainValidation: true,
        sessionTranscript: await SessionTranscript.forOid4VpDcApi(
          {
            origin: "https://funke.animo.id",
            nonce,
            jwkThumbprint: thumbprintDecoded,
          },
          mdocContext
        ),
        onCheck: (verification) => {
          console.log(verification);
        },
      },
      mdocContext
    );
    console.log("success", result);
  } catch (error) {
    console.error(error);
  }
}

main();
